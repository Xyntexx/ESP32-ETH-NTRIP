#include "ethernet.h"
#include "utils/log.h"

// MAC addresses configuration
const byte mac[][NUMBER_OF_MAC] =
{
    {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0x01},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xBE, 0x02},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0x03},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xBE, 0x04},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0x05},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xBE, 0x06},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0x07},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xBE, 0x08},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0x09},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xBE, 0x0A},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0x0B},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xBE, 0x0C},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0x0D},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xBE, 0x0E},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0x0F},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xBE, 0x10},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0x11},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xBE, 0x12},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0x13},
    {0xDE, 0xAD, 0xBE, 0xEF, 0xBE, 0x14},
};

// Ethernet configuration
IPAddress staticIP(STATIC_IP);
IPAddress gateway(STATIC_GW);
IPAddress subnet(STATIC_SN);
IPAddress dns(STATIC_DNS);

void getMacAddress(uint8_t* mac) {
    uint64_t chipmacid = ESP.getEfuseMac();
    mac[5] = (chipmacid >> 40) & 0xFF;
    mac[4] = (chipmacid >> 32) & 0xFF;
    mac[3] = (chipmacid >> 24) & 0xFF;
    mac[2] = (chipmacid >> 16) & 0xFF;
    mac[1] = (chipmacid >> 8) & 0xFF;
    mac[0] = chipmacid & 0xFF;
}

bool initializeEthernet() {
    debug("Initializing Ethernet...");
    ESP32_W6100_onEvent();
    
    // Get the ESP32's MAC address
    uint8_t mac[6];
    getMacAddress(mac);
    
    debugf("MAC: %02X:%02X:%02X:%02X:%02X:%02X", 
        mac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);
    
    ETH.begin(MISO_GPIO, MOSI_GPIO, SCK_GPIO, CS_GPIO, INT_GPIO, SPI_CLOCK_MHZ, ETH_SPI_HOST, mac);
    
    // Wait for connection
    if (USE_STATIC) {
        ETH.config(staticIP, gateway, subnet, dns);
    } else {
        debug("Waiting for DHCP connection...");
        while (ETH.localIP() == INADDR_NONE) {
            delay(500);
        }
    }

    if (ETH.localIP() == INADDR_NONE) {
        errorf("Failed to configure network - IP: %s", ETH.localIP().toString().c_str());
        return false;
    }

    debugf("Network configured - IP: %s", ETH.localIP().toString().c_str());
    return true;
}
